<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Telegram Video Library</title>

  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.css" />

  <style>
    :root { --bg:#0b1220; --card:#121a2b; --txt:#e6eefc; --muted:#9bb0d3; --accent:#4da3ff; }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt)}
    header{padding:16px 20px;display:flex;gap:12px;align-items:center;border-bottom:1px solid rgba(255,255,255,.06);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,18,32,.95),rgba(11,18,32,.85));backdrop-filter:blur(6px);z-index:10}
    header h1{margin:0;font-size:18px} .badge{font-size:11px;padding:2px 6px;border-radius:999px;background:rgba(77,163,255,.15);color:#bfe0ff;border:1px solid rgba(77,163,255,.35)}
    .container{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media(max-width:980px){.container{grid-template-columns:1fr}}
    .playerCard,.listCard{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .playerCard{padding:16px}.listCard{padding:12px}
    .controls{display:flex;gap:8px;margin:12px 0 4px;align-items:center}
    .controls input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0e1628;color:var(--txt);outline:none}
    .list{max-height:70vh;overflow:auto;padding-right:6px}
    .item{padding:10px;border-radius:10px;display:flex;gap:10px;align-items:center;cursor:pointer;border:1px solid transparent}
    .item:hover{background:#0e1628;border-color:rgba(255,255,255,.06)}
    .item .meta{flex:1;min-width:0}.title{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted)} .empty{color:var(--muted);padding:16px}
    footer{text-align:center;color:var(--muted);font-size:12px;padding:18px}
  </style>
</head>
<body>
<header>
  <h1>Telegram Video Library</h1>
  <span class="badge">Live from your public group</span>
</header>
<main class="container">
  <section class="playerCard">
    <!-- Plyr video player -->
    <video id="player" playsinline controls></video>
    <div id="nowPlaying" class="sub" style="margin-top:8px;"></div>
  </section>
  <aside class="listCard">
    <div class="controls">
      <input id="search" type="text" placeholder="Search caption / chat title…"/>
    </div>
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none;">No videos found.</div>
  </aside>
</main>
<footer>Powered by Telegram Bot API · Plyr Player</footer>

<!-- Plyr JS -->
<script src="https://cdn.jsdelivr.net/npm/plyr@3"></script>

<script>
  const BACKEND_BASE = location.origin; // same domain as deployed

  const state = { videos: [], filtered: [] };
  const els = {
    player: document.getElementById('player'),
    now: document.getElementById('nowPlaying'),
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    search: document.getElementById('search'),
  };

  // Init Plyr
  const plyr = new Plyr('#player', {
    controls: [
      'play-large', 'play', 'progress', 'current-time', 'duration',
      'mute', 'volume', 'settings', 'pip', 'airplay', 'fullscreen'
    ]
  });

  function fmtDur(s){ if(!s||isNaN(s)) return ''; s=+s; const m=Math.floor(s/60), r=s%60; return `${m}:${String(r).padStart(2,'0')}`; }
  
  function setNowPlaying(v){
    plyr.source = {
      type: 'video',
      sources: [
        { src: `${BACKEND_BASE}/api/stream/${encodeURIComponent(v.file_id)}`, type: 'video/mp4' }
      ]
    };
    const when = v.posted_at ? new Date(v.posted_at).toLocaleString() : '';
    els.now.textContent = `${v.caption || '(no caption)'} — ${v.chat_title || ''} ${when ? '· ' + when : ''}`;
    plyr.play().catch(()=>{});
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function renderList(list){
    els.list.innerHTML = '';
    if(!list.length){ els.empty.style.display='block'; return; }
    els.empty.style.display='none';
    list.forEach(v=>{
      const div=document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <div class="meta">
          <div class="title">${(v.caption||'(no caption)').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>
          <div class="sub">${v.chat_title || ''} · ${fmtDur(v.duration)}</div>
        </div>
        <div class="badge">Play</div>
      `;
      div.addEventListener('click',()=>setNowPlaying(v));
      els.list.appendChild(div);
    });
  }

  function applyFilter(){
    const q = els.search.value.trim().toLowerCase();
    state.filtered = !q ? state.videos.slice() :
      state.videos.filter(v => (v.caption||'').toLowerCase().includes(q) || (v.chat_title||'').toLowerCase().includes(q));
    renderList(state.filtered);
  }

  async function load(){
    const resp = await fetch(`${BACKEND_BASE}/api/videos`);
    const data = await resp.json();
    state.videos = data.videos || [];
    applyFilter();
    if(state.videos.length) setNowPlaying(state.videos[0]);
  }

  els.search.addEventListener('input', applyFilter);
  load();
</script>
</body>
</html>
